.PHONY: all clean slides figures

texfiles := $(wildcard *.tex)
allslides := $(patsubst %.tex, %.pdf, $(texfiles))

figfiles := $(wildcard src/*.py)
allfigures := $(patsubst %.py, %.pdf, $(figfiles))

all: clean vc.tex figures slides

all-wo-figures: clean vc.tex slides

clean:
	rm -rf *.aux *.auxlock *.ind *.idx *.toc *.out *.log *.lot *.ilg *.dvi *.bbl \
	  *.blg *.sub *.suc *.syc *.sym *.syg *.syi *.synctex *.slg *.lol *.lof \
	  *.fls *.xdv *-blx.bib *.fdb_latexmk \
	  *.ist *.gls *.glo *.gli *.glg *.alg *.acr *.acn *.ps *.defn *.nlo *.satz \
	  *.nav *.snm *.xml *.synctex.gz *.synctex *.vrb *.bcf *.makefile *.figlist \
	  $$(ls figures/$(SLIDES)-figure[0-9]*.* 2>/dev/null | grep -v pdf) \
	  $$(ls figures/$(HANDOUT)-figure[0-9]*.* 2>/dev/null | grep -v pdf) \
	  output

%.pdf: %.tex FORCE
	mkdir -p output
	latexmk -pdf --interaction=nonstopmode -shell-escape -silent -f -output-directory=output/ $<

src/%.pdf: src/%.py FORCE
	python3 $<

slides: $(allslides)

figures: $(allfigures)

FORCE: ;

vc.tex: ../.git/logs/HEAD
	echo "%%% This file is generated by Makefile." > x-additional/vc.tex
	echo "%%% Do not edit this file!\n%%%" >> x-additional/vc.tex
	git log -1 --format="format:\
		\\gdef\\GITAbrHash{%h}\
		\\gdef\\GITAuthorDate{%ad}\
		\\gdef\\GITAuthorName{%an}" >> x-additional/vc.tex
